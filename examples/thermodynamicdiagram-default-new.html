<html>
  <head>
    <title>Thermodynamic diagram - Default appearance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.4/svg.min.js" integrity="sha256-c41axQEd+/UIEXHKMkvkD0bDuKHCdlBd+13pZLCvsro=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/regenerator-runtime@0.13.1/runtime.js"></script>
    <script src="../meteoJS.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div class="container"">
      <div class="row">
        <div class="col">
          <h1>Default appearance</h1>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <div class="btn-group" role="group" aria-label="Toggle coordinate system">
              <button id="stueve" type="button" class="btn btn-primary">Stueve</button>
              <button id="skewTlogP" type="button" class="btn btn-primary">skew-T-log-P</button>
              <button id="emagram" type="button" class="btn btn-primary">Emagram</button>
            </div>
            <div class="btn-group" role="group" aria-label="Toggle minimum pressure">
              <button id="pressure100" type="button" class="btn btn-primary">Up to 100 hPa</button>
              <button id="pressure500" type="button" class="btn btn-primary">Up to 500 hPa</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="sounding col-8" style="height: 730px"></div>
        <div class="sounding col-4" style="height: 300px"></div>
        <div class="sounding col-12" style="height: 600px"></div>
      </div>
      <div class="row">
        <p>Sounding data source: <a href="http://weather.uwyo.edu/cgi-bin/sounding?region=europe&TYPE=TEXT%3ALIST&YEAR=2018&MONTH=01&FROM=0312&TO=0312&STNM=06610" target="_blank">weather.uwyo.edu</a></p>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    $(document).ready(function () {
      var tDs = [];
      $('div.sounding').each((i, renderTo) => {
        tDs.push(new meteoJS.ThermodynamicDiagram({
          renderTo
        }));
      });
      $('#stueve').click(() => {
        tDs.map(td => td.coordinateSystem = new meteoJS.thermodynamicDiagram.coordinateSystem.StueveDiagram({ width: td.getDiagramPlotArea().width, height: td.getDiagramPlotArea().height }));
      });
      $('#skewTlogP').click(() => {
        tDs.map(td => td.coordinateSystem = new meteoJS.thermodynamicDiagram.coordinateSystem.SkewTlogPDiagram({ width: td.getDiagramPlotArea().width, height: td.getDiagramPlotArea().height }));
      });
      $('#emagram').click(() => {
        tDs.map(td => td.coordinateSystem = new meteoJS.thermodynamicDiagram.coordinateSystem.Emagram({ width: td.getDiagramPlotArea().width, height: td.getDiagramPlotArea().height }));
      });
      $('#pressure100').click(() => {
        tDs.map(td => td.coordinateSystem.update({ pressure: { min: 100 }}));
      });
      $('#pressure500').click(() => {
        tDs.map(td => td.coordinateSystem.update({ pressure: { min: 500 }}));
      });
      //$.ajax('data/sounding_obs_pay_2018010312.txt', {
      $.ajax('https://chird.github.io/meteoJS/examples/data/sounding_obs_pay_2018010312.txt', {
        dataType: 'text',
        processData: false
      })
      .done(function (data) {
        var sounding = new meteoJS.Sounding({
          parcels: [new meteoJS.sounding.Parcel({
            id: 'test',
            pres: 1000,
            tmpc: 20,
            dwpc: -10,
            lclpres: 650,
            lclhght: 4000
          })]
        });
        data.split("\n").forEach(function (line) {
          if (/^[-0-9 .]+[0-9][-0-9 .]+$/.test(line)) {
            var parts = line.match(/.{7}/g) || [];
            parts = parts.map(function (p) {
              return (/^[\s]+$/.test(p)) ? undefined : +p;
            });
            if (parts.length < 8)
              Array.prototype.push.apply(parts,
                  Array(8 - parts.length).fill(undefined));
            sounding.addLevel({
              pres: parts[0],
              hght: parts[1],
              tmpk: meteoJS.calc.tempCelsiusToKelvin(parts[2]),
              dwpk: meteoJS.calc.tempCelsiusToKelvin(parts[3]),
              wdir: parts[6],
              wspd: meteoJS.calc.windspeedKNToMS(parts[7])
            });
          }
        });
        tDs.forEach(function (tD) {
          let diagramSounding = tD.addSounding(sounding);
          diagramSounding.update({
            parcels: {
              test: {
                visible: true
              }
            }
          });
          tD.getDiagramPlotArea().on('click', e => {
            if (e.diagramPres === undefined)
              return;
            
            let pres = sounding.getNearestLevel(e.diagramPres);
            if (pres === undefined)
              return;
            
            const levelData = sounding.getData(pres);
            if (levelData === undefined)
              return;
            
            let dwpc = meteoJS.calc.tempKelvinToCelsius(levelData.dwpk);
            let tmpc =
              meteoJS.calc.tempKelvinToCelsius(meteoJS.calc.tempByPotentialTempAndPres(meteoJS.calc.potentialTempByTempAndPres(e.diagramTmpk, e.diagramPres), levelData.pres));
            let parcel = new meteoJS.sounding.Parcel({
              id: 'test',
              pres,
              tmpc,
              dwpc
            });
            sounding.parcelCollection.append(parcel);
          });
        });
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        $('div.container').append(
          $('<div>').addClass('row').append(
            $('<div>').addClass('col').append(
              $('<p>')
                .addClass('alert alert-danger')
                .text('Loading sounding data failed ('+jqXHR.statusText+')')
        )));
      });
    });
  </script>
</html>